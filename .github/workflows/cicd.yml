name: CI/CD Pipeline

on:
  push:
    branches: ["main"]

jobs:

  # ---------- CI: Tests ----------
  test:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout
      uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: "3.11"

    - name: Install dependencies
      run: pip install -r requirements.txt

    # ✅ Authenticate to GCP so MLflow can download from GCS
    - name: Authenticate to Google Cloud
      uses: google-github-actions/auth@v1
      with:
        credentials_json: ${{ secrets.GCP_SA_KEY2 }}

    # ✅ Set environment variables for MLflow + GCS auth
    - name: Download Models
      env:
        MLFLOW_TRACKING_URI: ${{ secrets.MLFLOW_TRACKING_URI }}
        GOOGLE_APPLICATION_CREDENTIALS: ${{ env.GOOGLE_APPLICATION_CREDENTIALS }}
      run: python download_models.py

    - name: Run tests
      run: python -m pytest tests/test_model_availability.py


  # ---------- CD: Deploy to VM ----------
  deploy:
    runs-on: ubuntu-latest
    needs: test
    if: github.ref == 'refs/heads/main'

    steps:
    - name: Checkout
      uses: actions/checkout@v4

    # ✅ Authenticate for deployment + model download on VM
    - name: Authenticate to Google Cloud
      uses: google-github-actions/auth@v1
      with:
        credentials_json: ${{ secrets.GCP_SA_KEY2 }}

    - name: Set up Cloud SDK
      uses: google-github-actions/setup-gcloud@v1
      with:
        project_id: ${{ secrets.GCP_PROJECT_ID }}

    - name: Deploy to VM
      run: |
        gcloud compute ssh ${{ secrets.VM_USER }}@${{ secrets.VM_NAME }} --zone=${{ secrets.GCP_ZONE }} --command="
          cd /home/${{ secrets.VM_USER }}/inference-app
          git pull

          if [ ! -d 'venv' ]; then
            python3 -m venv venv
          fi

          source venv/bin/activate

          pip install -r requirements.txt

          export MLFLOW_TRACKING_URI='${{ secrets.MLFLOW_TRACKING_URI }}'
          python download_models.py

          sudo systemctl restart inference.service
        "
